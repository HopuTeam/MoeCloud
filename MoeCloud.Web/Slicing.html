
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>分片上传</title>
    <!-- <link href="/static/mdui/css/mdui.min.css" /> -->
    <link href="/static/webuploader/webuploader.css" />
</head>
<body>
    <div id="uploader" class="wu-example">
        <span style="color:red">只能上传mpg、mpeg、mp4、avi格式的视频文件</span>
        <div id="thelist" class="uploader-list"></div>
        <div class="btns">
            <div id="picker" class="webuploader-container"><div class="webuploader-pick">选择文件</div><div style="position: absolute; top: 0px; left: 0px; width: 88px; height: 34px; overflow: hidden; bottom: auto; right: auto;"><input type="file" name="file" class="webuploader-element-invisible" multiple="multiple"><label style="opacity: 0; width: 100%; height: 100%; display: block; cursor: pointer; background: rgb(255, 255, 255);"></label></div></div>
            <button id="ctlBtn" class="btn btn-default">开始上传</button>
        </div>
    </div>
    <button id="jwt" >访问Api</button>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/webuploader/webuploader.min.js"></script>
    <script>
        $(document).ready(function () {
           
                var $ = jQuery,
                    $list = $('#thelist'),
                    $btn = $('#ctlBtn'),
                    state = 'pending',
                    fileMd5,
                    flag = true,
                    dataState,
                    fm = [],
                    fnum,
                    Token,
                    uploader;
                var FileExt = ["mpg", "mpeg", "avi","jpg",".doc",".mp4)"];
                // Token = '@ViewBag.Token';
                // if (Token == '' || Token == 'undefined') {s
                //    $("#uploader").hide();
                //    alert("登录超时，请重新登录。");
                // }
                //监听分块上传过程中的三个时间点
                WebUploader.Uploader.register({
                    "before-send-file": "beforeSendFile",
                    "before-send": "beforeSend",
                    "after-send-file": "afterSendFile",
                }, {
                    beforeSendFile: function (file) {
                        var startTime = new Date(file.lastModifiedDate);
                        fileName = file.name;
                        var deferred = WebUploader.Deferred();
                        (new WebUploader.Uploader()).md5File(file, 0, 10 * 1024 * 1024)
                            .progress(function (percentage) {
                                console.log("正在读取文件");
                            })
                            .then(function (val) {
                                fileMd5 = val;
                                fm.push(fileMd5);
                                deferred.resolve();
                            });
                        return deferred.promise();
                    },
                    //时间点2：如果有分块上传，则每个分块上传之前调用此函数
                    beforeSend: function (block) {
                        var deferred = WebUploader.Deferred();

                        //上传前ajax检测一下此文件块是否已经上传

                        this.owner.options.formData.fileMd5 = fileMd5;
                        this.owner.options.formData.chunk = block.chunk;
                        deferred.resolve();
                        return deferred.promise();
                    },
                    //时间点3：所有分块上传成功后调用此函数
                    afterSendFile: function (file) {
                        var deferred = $.Deferred();
                        $('#' + file.id).find('p.state').text('执行最后一步');
                        console.log(file);
                        console.log(file.guid);
                        $.ajax({
                            type: "POST",
                            url: "https://localhost:44393/FileUpload/FileMerge",
                            data: {
                                guid: file.guid,
                                fileMd5: fm[fnum],
                                fileName: file.name
                            },
                            cache: false,
                            async: false,
                            success: function (response) {
                                fnum++;
                                console.log(response);
                                if (response.success == true) {
                                    dataState = response;
                                    flag = true;
                                } else {
                                    flag = false;
                                }
                                deferred.resolve();
                            },
                            error: function () {
                                fnum++;
                                dataState = undefined;
                                flag = false;
                                deferred.reject();
                            }
                        });

                        return deferred.promise();
                    }
                });
                uploader = WebUploader.create({
                    resize: false,
                    fileNumLimit: 10,
                    swf: '/static/webuploader/Uploader.swf',
                    server: "https://localhost:44393/FileUpload/FileSave",
                    pick: '#picker',
                    chunked: true,
                    chunkSize: 10 * 1024 * 1024,
                    chunkRetry: 5
                    , formData: {
                       guid: GUID
                    }
                });
                uploader.on('beforeFileQueued', function (file) {
                    var isAdd = false;
                    for (var i = 0; i < FileExt.length; i++) {
                        if (file.ext == FileExt[i]) {
                            file.guid = WebUploader.Base.guid();
                            isAdd = true;
                            break;
                        }
                    }
                    return isAdd;
                });
                uploader.on('uploadBeforeSend', function (object, data, headers) {
                    //console.log(object);
                    // headers.Authorization = Token;
                    data.guid = object.file.guid;
                });
                // 当有文件添加进来的时候
                uploader.on('fileQueued', function (file) {
                    $list.append('<div id="' + file.id + '" class="item">' +
                        '<h4 class="info">' + file.name + '</h4>' +
                        '<input type="hidden" id="h_' + file.id + '" value="' + file.guid + '" />' +
                        '<p class="state">等待上传...</p>' +
                        '</div>');
                });

                // 文件上传过程中创建进度条实时显示。
                uploader.on('uploadProgress', function (file, percentage) {
                    var $li = $('#' + file.id),
                        $percent = $li.find('.progress .progress-bar');
                    // 避免重复创建
                    if (!$percent.length) {
                        $percent = $('<div class="progress progress-striped active">' +
                            '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                            '</div>' +
                            '</div>').appendTo($li).find('.progress-bar');
                    }
                    $li.find('p.state').text('上传中');

                    $percent.css('width', percentage * 100 + '%');
                });

                uploader.on('uploadSuccess', function (file) {
                    if (dataState == undefined) {
                        $('#' + file.id).find('p.state').text('上传失败');
                        $('#' + file.id).find('button').remove();
                        $('#' + file.id).find('p.state').before('<button id="retry" type="button" class="btn btn-primary fright retry pbtn">重新上传</button>');
                        flag = false;
                        file.setStatus('error');
                    }
                    if (dataState.success == true) {
                        $('#' + file.id).find('p.state').text('已上传');
                        $('#' + file.id).find('button').remove();

                    } else {
                        $('#' + file.id).find('p.state').text('上传失败');
                        flag = false;
                    }
                });

                uploader.on('uploadError', function (file) {
                    $('#' + file.id).find('p.state').text('上传出错');
                });

                uploader.on('uploadComplete', function (file) {
                    $('#' + file.id).find('.progress').fadeOut();
                });

                uploader.on('all', function (type) {
                    if (type === 'startUpload') {
                        state = 'uploading';
                    } else if (type === 'stopUpload') {
                        state = 'paused';
                    } else if (type === 'uploadFinished') {
                        state = 'done';
                    }
                    if (state === 'done') {
                        $btn.text('继续上传');
                    } else if (state === 'uploading') {
                        $btn.text('暂停上传');
                    } else {
                        $btn.text('开始上传');
                    }
                });
                $btn.on('click', function () {
                    if (state === 'uploading') {
                        uploader.stop();
                    } else if (state == 'done') {
                        window.location.reload();
                    }
                    else {
                        uploader.upload();
                    }
                });
           



        });
       $('#jwt').click(function () {
          $.ajax({
              url:'https://localhost:44393/FileUpload/JwtYz',
              type: "Post",
              contentType: "application/json",
              data: JSON.stringify(12),
              success:function(res){
                  console.log(res);
              }
          })
       })
    </script>

</body>
</html>